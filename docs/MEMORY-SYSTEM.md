# Memory System Architecture

## Overview

Genius Team v9.0 uses a **file-based memory system** — no external MCPs or services required. All memory lives in `.genius/memory/` and is managed by bash scripts.

## Directory Structure

```
.genius/memory/
├── BRIEFING.md          # Auto-generated summary (~150 lines)
├── decisions.json       # Key decisions with rationale
├── patterns.json        # Code patterns and conventions
├── progress.json        # Task progress (7-day decay)
├── errors.json          # Resolved errors and solutions
└── session-logs/        # Compressed session logs (30-day retention)
    ├── 2025-01-29-1000.md
    ├── 2025-01-29-1430.md
    └── ...
```

## File Formats

### decisions.json
```json
[
  {
    "id": "d-a1b2c3d4",
    "decision": "ARCH: Using Next.js 14 with App Router",
    "reason": "Best fit for SSR + API routes, team familiarity",
    "timestamp": "2025-01-29T10:00:00",
    "tags": ["decision", "architecture"]
  }
]
```

### patterns.json
```json
[
  {
    "id": "p-e5f6g7h8",
    "pattern": "All API routes use Zod for input validation",
    "context": "Established in Phase 3 — auth endpoints",
    "timestamp": "2025-01-29T12:00:00"
  }
]
```

### progress.json
```json
[
  {
    "id": "t-i9j0k1l2",
    "task": "Implement Button component",
    "status": "completed",
    "timestamp": "2025-01-29T11:30:00"
  }
]
```

### errors.json
```json
[
  {
    "id": "e-m3n4o5p6",
    "error": "Supabase RLS policy blocking read access",
    "solution": "Added SELECT policy for authenticated users",
    "timestamp": "2025-01-29T14:00:00",
    "tags": ["supabase", "rls"]
  }
]
```

## BRIEFING.md

Auto-generated summary with a **line budget system**:

| Section | Budget | Content |
|---------|--------|---------|
| Architecture & State | 25 lines | Version, phase, task counts, artifacts |
| Key Decisions | 25 lines | Last 10 decisions from decisions.json |
| Active Patterns | 25 lines | Last 10 patterns from patterns.json |
| Recent Errors | 20 lines | Last 8 errors from errors.json |
| Progress | 30 lines | Tasks from last 7 days |
| Context | 15 lines | Memory stats, session logs, checkpoints |
| **Total** | **~140 lines** | |

Generated by `scripts/memory-briefing.sh`.

## Scripts

### memory-briefing.sh

Generates BRIEFING.md from all JSON files.

**When it runs:**
- SessionStart hook (every session)
- After memory-extract.sh
- After `/genius-start`

**What it does:**
1. Reads state.json for phase and task counts
2. Reads plan.md for task summary
3. Reads each JSON memory file
4. Applies line budget per section
5. Writes BRIEFING.md

### memory-extract.sh

Extracts decisions, patterns, and errors from session context.

**When it runs:**
- PreCompact hook (before context compaction)
- Stop hook (on session end)

**What it does:**
1. Reads context (STDIN or PROGRESS.md + plan.md)
2. Saves session log to `session-logs/YYYY-MM-DD-HHmm.md`
3. Extracts lines matching DECISION/ERROR/PATTERN patterns
4. Deduplicates against existing JSON entries
5. Appends new entries to respective JSON files
6. Prunes progress.json entries older than 7 days
7. Deletes session logs older than 30 days
8. Regenerates BRIEFING.md

## Lifecycle

```
Session Start
    │
    ├─→ memory-briefing.sh → BRIEFING.md regenerated
    ├─→ SessionStart hook loads BRIEFING.md
    │
    ▼
Working Session
    │
    ├─→ Skills read BRIEFING.md for context
    ├─→ Skills append to .json files on decisions/errors/patterns
    │
    ▼
Before Compaction (PreCompact)
    │
    ├─→ memory-extract.sh extracts from session context
    ├─→ BRIEFING.md regenerated
    │
    ▼
Session End (Stop)
    │
    ├─→ Task counts synced to state.json
    │
    ▼
Next Session
    │
    ├─→ BRIEFING.md has full context from previous sessions
    └─→ No data loss between sessions
```

## Decay & Retention

| Data | Retention | Reason |
|------|-----------|--------|
| decisions.json | Permanent | Decisions rarely become irrelevant |
| patterns.json | Permanent | Patterns persist across the project |
| errors.json | Permanent | Knowing what broke helps avoid repeats |
| progress.json | 7 days | Old task completion isn't useful |
| session-logs/ | 30 days | Raw logs are for debugging, not long-term |

## Integration with Skills

Every skill follows the same pattern:

1. **Session start**: "Read `@.genius/memory/BRIEFING.md` for project context"
2. **On decisions**: Append to `.genius/memory/decisions.json`
3. **On errors**: Append to `.genius/memory/errors.json`
4. **On patterns**: Append to `.genius/memory/patterns.json`

No skill uses `mind_recall()`, `mind_log()`, `mind_search()`, or `mind_remind()`. Those are v8 patterns that have been fully replaced.

## Manual Operations

### Regenerate BRIEFING.md
```bash
bash scripts/memory-briefing.sh
```

### View memory stats
```bash
for f in .genius/memory/*.json; do echo "$f: $(jq length "$f") entries"; done
```

### Clean old progress
```bash
CUTOFF=$(date -v-7d '+%Y-%m-%d')
jq --arg c "$CUTOFF" '[.[] | select(.timestamp >= $c)]' .genius/memory/progress.json > tmp && mv tmp .genius/memory/progress.json
```

### Search memory
```bash
jq '.[] | select(.decision | test("supabase"; "i"))' .genius/memory/decisions.json
```
